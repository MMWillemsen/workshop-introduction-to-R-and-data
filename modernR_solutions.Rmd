---
title: "Modern R with tidyverse [Solutions]"
author: "Jonathan de Bruin & Barbara Vreede"
output:
  pdf_document:
    toc: yes
    latex_engine: xelatex
  html_document:
    toc: yes
---

*This document is part of the workshop **Introduction to R & Data** by Utrecht University RDM Support. *

This document is work in progress.

```{r} 
library(tidyverse) 
```

# 1. Read and save data

### Basic exercise I - Read data files

#### a) Read the dataset `menus.csv`

```{r error=TRUE}
filepath <- file.path('data', 'menus.csv')
data_menus <- read_csv(filepath)

head(data_menus)
```

#### b) Load `readxl`


```{r error=TRUE}
library("readxl")
```

#### c) Read the restaurants dataset

```{r error=TRUE}

filepath <- file.path('data', 'restaurants.xlsx')
data_restaurants <- read_excel(filepath)

head(data_restaurants)
```


### Basic exercise II - Dataset properties 

```{r error=TRUE}

glimpse(data_restaurants)
glimpse(data_menus)
```

### Reading exercise - `readr` versus base R


### Optional exercise (+) - Save data to a CSV file. 

```{r error=TRUE}

write_delim(data_menus, "menus_in_csv_format.csv", delim = ";")
```

### Optional exercise (++) - Read SPSS, SAS and Excel data files

```{r}
library("haven") # to read and write SPSS, STATA and SAS files
library("readxl") # to read Excel files
```

#### a) Write data frame to SPSS, SAS, STATA data files. 

```{r}

# create a directory
if (!dir.exists('tmp')){
  dir.create("tmp")
}

# read and write files
write_sav(data_restaurants, file.path("tmp", "restaurants_spss.sav"))
data_restaurants_spss <- read_sav(file.path("tmp", "restaurants_spss.sav"))

write_sas(data_restaurants_spss, file.path("tmp", "restaurants_sas.sas7bdat"))
data_restaurants_sas <- read_sas(file.path("tmp", "restaurants_sas.sas7bdat"))

write_dta(data_restaurants_sas, file.path("tmp", "restaurants_stata.dta"))
data_restaurants_stata <- read_dta(file.path("tmp", "restaurants_stata.dta"))

head(data_restaurants_stata)

```


#### b) Write data frame to Excel. 

This is not possible with `tidyverse` at the moment. `readxl` only support Excel file reading. This is not a problem for a researcher, because we don't use Excel, isn't it?

### Optional exercise (+++) - Parse datetime columns

No solutions available at the moment.

# 2. Data visualisation

### Basic exercise I - Quick plots of the menus

#### a) Single column plots

```{r error=TRUE}

qplot(data_menus$menus.amountMax)
qplot(data_menus$menus.amountMin)
qplot(data_menus$menus.currency)
qplot(data_menus$menus.dateSeen)
qplot(data_menus$menus.description)

```
#### b) Two column in plots

```{r error=TRUE}

qplot(x = data_restaurants$priceRangeMin, y = data_restaurants$priceRangeMax)
qplot(x = data_restaurants$state, y = data_restaurants$priceRangeMax)

```



### Basic exercise II - Using ggplot for graphs

```{r error=TRUE}

ggplot(data_menus, aes(menus.amountMax, menus.amountMin)) + 
  geom_count()

```


### Reading exercise - Statistical layers for graphs.


### Optional excercise (+) - Scale axis

```{r error=TRUE}
ggplot(data_restaurants, aes(priceRangeMin, priceRangeMax)) + 
  geom_point() + 
  scale_x_continuous(limits = c(0, 100)) +
  scale_y_continuous(limits = c(0, 100))
```



### Optional excercise (++) - Plot the restaurants on a map

#### a) Install package the `maps`

```{r}

# install.packages('maps')
library(maps)
```

#### b) Plot the restaurants on the map of the USA.

```{r error=TRUE}
usa <- map_data("usa")

ggplot(data_restaurants) +
  geom_polygon(data = usa, aes(x=long, y = lat)) + 
  geom_point(aes(x=longitude, y=latitude))

```


#### c) Use the maximum price to colour the restaurants.

```{r error=TRUE}
usa <- map_data("usa")

ggplot(data_restaurants) +
  geom_polygon(data = usa, aes(x=long, y = lat)) + 
  geom_point(aes(x=longitude, y=latitude, colour=priceRangeMin))
```

### Optional exercise (+++) - Create facets. 

```{r fig.height=15, fig.width=6}

ggplot(data_restaurants) + 
  geom_histogram(aes(x = priceRangeMin)) + 
  facet_wrap(~ state, ncol = 5)

```



# 3. Data transformation

### Basic exercise I - Subset data

#### a) Make a selection of all restaurants in 'Los Angeles'.

```{r error=TRUE}

filter(data_restaurants, city=='Los Angeles')

```

#### b) Make a selection of all restaurants in 'Los Angeles' where the variable `priceRangeMin` isn't missing.

```{r error=TRUE}

filter(data_restaurants, city=='Los Angeles' & !is.na(priceRangeMin))

```

#### c) Make a selection of all restaurants in 'Los Angeles' where the variable `priceRangeMin` is not missing. Return only the `address` and `name` of the restaurants. 

```{r error=TRUE}

data_restaurants_filtered <- filter(data_restaurants, city=='Los Angeles' & !is.na(priceRangeMin))

select(data_restaurants_filtered, address, name)
```

### Basic exercise II - Compute the price range

```{r error=TRUE}

data_restaurants_with_price_range <- mutate(data_restaurants,  
  # compute the price range
  priceRangeDiff = priceRangeMax - priceRangeMin
)

head(data_restaurants_with_price_range)

```

### Basic exercise III - Filter outliers

```{r}
data_restautants_wo_outliers <- filter(data_restaurants, priceRangeMin < 100, priceRangeMax < 100)

ggplot(data_restautants_wo_outliers, aes(priceRangeMin, priceRangeMax)) +
  geom_point()
```


### Reading exercise - Pipe operator

### Optional exercise (+) - Exclude variables

Create a tibble of the restaurant dataset without the latitude and longitude. 

Use tidyverse and a maximum of 75 characters. (Our best result is 42 characters.)

```{r}

select(data_restaurants, -latitude, -longitude)
```

### Optional exercise (++) - Summarise results

```{r}

summarise(data_menus, 
          mean_min_price = mean(menus.amountMin, na.rm = T),
          mean_max_price = mean(menus.amountMax, na.rm = T),
          mean_diff_price = mean(menus.amountMax - menus.amountMin, na.rm = T)
)

```

### Optional exercise (+++) - Join datasets

```{r error=TRUE}

data_pizza_with_restaurant <- left_join(data_menus, data_restaurants, by="id")
head(data_pizza_with_restaurant)

```

Multiple options give the same results. Explain why!

