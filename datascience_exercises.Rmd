---
title: "Data science in the Tidyverse"
author: "[Insert your name]"
output:
  html_document:
    toc: true
---
<!-- This code block sets some defaults for the code chunks, and can safely be ignored! -->
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, error = TRUE)
```


*This document is part of the workshop **Introduction to R & Data** by Utrecht University RDM Support. *

# Introduction

Each of the following chapters will have multiple exercises to let you practice with the functions we introduce.
Through these exercises, we will move a dataset through the different steps in a data science workflow.
This means that often the results of one step will be the input for the next.
If this is the case, the exercise will get a label: REQUIRED.
Make sure you complete this exercise successfully, or you will not be able to proceed to the next theme.


## Technical requirements

We are going to use a series of packages that are part of the Tidyverse.
These packages were designed with data science in mind.
We can load them all at once using the following code:

```{r} 
library(tidyverse) 
```

# Chapter 1: Importing data

## Exercise 1 (REQUIRED)

In this exercise, we read the dataset `penguins_raw.tsv` into R. 

You will need to know three things to complete this exercise:
- The **location** of your data;
- The **delimiter** of the data;
- The **function** to use to read data into R.

You can find the dataset in the `data` folder of your project.
Note that the file **location** (argument `file`) should be `data/penguins_raw.tsv`, as you are referring to its location (or 'path') relative to the location of this exercise file.

The **delimiter** is the character that separates the values in a tabular data file.
There are various ways to find out how the datasets is delimited.
One way from inside Rstudio is to use the 'Import Dataset' button (in your 'Environment') window, choose 'from Text (readr)', locate your data, and play around with the delimiter settings at the bottom.
In the preview window you see the result of your settings on how your data will be loaded.

With this method, you can also find the **function** to use: at the bottom-right, Rstudio shows you the code that corresponds to your settings. You only need to copy the function

Complete the code in the chunk below, replacing the ??? with your code:

```{r}
penguins <- read_???(file = ???,
                       delim = ???)
```


## Exercise 2

The penguin dataset we just loaded contains a column with dates (`Date Egg`).
To load the dates correctly, so we can do direct calculations on them, we need to specify the date format.
For this, we use the argument `col_types`.

Use the 'Import Dataset' button again to play around with readr settings.
First, ensure the delimiter is set correctly so you can play with the column formats.
For this, click on the column headers in the preview to adjust the data type.

Can you figure out what %m, %d, and %Y do? And how to place them in the right order, so your date is parsed correctly?

```{r}
penguins <- read_delim(file = "data/penguins_raw.tsv",
                       delim = "\t",
                       col_types = ???)
```


## Exercise 3

`read_csv` and `read_delim` are useful functions for most tabular data files, but they are unable to read excel files.
For this, we need an additional package.

The package `readxl` is a tidyverse package to read Excel files.
It is installed when you installed the tidyverse, but it does not load by default when you call `library(tidyverse)`. 
So, we first need to load this package with the function `library()`:

```{r}
library(readxl)
```

Included in the *package* `readxl` is the *function* `read_excel`.
Use the function `read_excel()` to read a related data set `penguins_isotopes.xlsx` (an Excel file!), also located in your `data` folder, into R.
If you have trouble figuring out this function, try the Help option with `?read_excel`.
Or use the 'Import Dataset' button and choose 'From Excel'.

```{r}

penguins_isotopes <- read_???(path = ???)
  
```


# Chapter 2: Clean and tidy

## Exercise 4 (REQUIRED)

We are going to clean up our data, first by subsetting only the relevant information.
For some of the penguins, the sex was not determined.
We want to remove those from the dataset.

Use the function `filter()` to include only rows with penguins where the column `Sex` is FEMALE or MALE.

One way to do this (though not the only way!), is to filter out the rows where `Sex` is NA.
Remember the function `is.na()`, and remember that to negate a condition, you use the operator !

For example, `!TRUE` is False, and `!FALSE` is True.

```{r}

penguins_subset <- filter(penguins, ???)

```


## Exercise 5 (REQUIRED)

We are going to select columns with relevant data, for our upcoming analysis.
The research we do is on penguin bill sizes (described in our data with the word "Culmen").
We want to include a few relevant variables so we can analyse them later:
- `Individual ID` (**note** that multiple words as a column name need `` to stay together!)
- Species
- Sex
- Island

And we want to include the data on Culmen measurements.

Use the function `select()` to include the right columns in our data subset.

Take a look at [tidyselect](https://tidyselect.r-lib.org/reference/language.html) for functions you can use inside the function `select()`.

**Note** that in order to work with the subset from Exercise 4, we need to use that data frame (`penguin_subset`) as our data input!

```{r}

penguins_subset <- select(penguins_subset, ???)

```


# Exercise 6 (REQUIRED)

Combine your row and column subsets using the %>% operator.
Use the code you wrote during exercises 4 and 5, and make a workflow that starts with the data `penguins`, and subsequently applies your `filter` and `select` operations.

Make sure to remove the data arguments from your earlier code, as this is now provided through the %>% operator!

```{r}

penguins_subset <- penguins %>% ???
  
```


## Exercise 7

We want to make a metric called `culmen_ratio`, which is defined as the length of the bill (culmen) divided by the depth.

Use the function `mutate()` to add this ratio.
Make sure to work with the `penguins_subset` data.

```{r}
penguins_subset <- penguins_subset %>%
  mutate(culmen_ratio = ???)
```


## Exercise 8
(Building on exercise 3)


In this exercise we will append the crane dataset with the additional measures. We will do a full join, combining all data from `data_crane` with all data from `data_crane_additional`. (Note though that both datasets have the same unique identifiers, so both a right join and a left join would achieve the same results.)

Join the two data frames by adding to the code below. What column should you use as join key (the `by=` argument)?

*Tip: for more information about joining data, take a look at the cheat sheet element 'Combine Tables', or the recommended reading for this chapter.*

```{r}

data_crane_with_measures <- full_join(## enter your code here ##

```


## Exercise (O)
<!-- Explain -->

```{r}
penguins <- rename(penguins,
                   length = `Culmen Length (mm)`,
                   depth = `Culmen Depth (mm)`)


penguins <- pivot_longer(penguins, 
                         cols = c(length, depth),
                         names_to = "culmen_element", values_to = "measurement_mm")

```



### Exercise 2 (O)
<!-- Explain -->

```{r}
# optional: pivot back to original



```



### Exercise 2 (O)
<!-- Explain -->

```{r}
penguins_summary <- penguins %>%
  group_by(Species, culmen_element) %>%
  summarize(average_mm = mean(measurement_mm),
            sd = sd(measurement_mm))

```



### Exercise 2 (O)
<!-- Explain -->


Save the tibble `data_crane` to a `.csv` file. Use `;` as delimiter. To do this, you can use the function `write_delim`. Again, you can make use of its help function if you want to understand how the function works: type `?write_delim` in your console.

*Tip: Use a different file name, otherwise you overwrite the original data*
*Tip: You can save the file to a specific folder by including it in the path, just like you did when you read the file in exercise I-1. For instance:* `data/other_file_name.csv` *will save your file in the* `data` *folder*.
```{r}
# optional: write back to file

```



### Exercise 2 (O)
<!-- Explain -->

```{r}
ggplot(penguins_summary,
       aes(x = culmen_element,
           y = average_mm, 
           fill = Species)) +
  geom_bar(position=position_dodge(), stat="identity") +
  geom_errorbar(aes(ymin=average_mm-sd, 
                      ymax=average_mm+sd), 
                  width=.1, position=position_dodge(.9)) +
  labs(title = "Penguin culmen measurements",
       x = "Measurement",
       y = "Size (mm)") +
  scale_fill_manual(values = c("darkorange","purple","cyan4")) +
  theme_bw()

```



### Exercise 2 (O)
<!-- Explain -->

```{r}
penguins_clean <- palmerpenguins::penguins %>%
  filter(!is.na(sex))

```

The power of ggplot is in the use of different layers that build up an image. Your plot consists of your data, its mapping to a plot, and one or multiple geometric layers that translate the data to a visual representation.

Play with that translation in showing the cranes' ground speed by the angle in which they are heading. Try various geometric layers and see what they do. Examples are `geom_point`, `geom_line`, `geom_count` and `geom_density_2d`, but feel free to search for others!

*Tip: write `geom_` in the search field of the help tab in RStudio to find more geometric layers.*

Complete the following code. (Note that the plot is first generated as p, but not printed yet: it is saved as a variable. You can then always call p and add layers to it.)

```{r}

ggplot(penguins_clean, aes(x = bill_length_mm,
                           y = bill_depth_mm,
                           color = species)) +
  geom_point() +
  scale_color_manual(values = c("darkorange","purple","cyan4")) +
  stat_density2d() +
  theme_bw()
```



```{r}



ggplot(penguins_clean, aes(x = body_mass_g,
                           y = flipper_length_mm,
                           color = species)) +
  geom_point() +
  scale_color_manual(values = c("darkorange","purple","cyan4")) +
  facet_grid(sex ~ island) +
  theme_bw()



```







