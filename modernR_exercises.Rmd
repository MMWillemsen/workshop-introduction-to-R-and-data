---
title: "Modern R with tidyverse"
author: "[Insert your name]"
output: 
  html_document:
    toc: true
---

*This document is part of the workshop **Introduction to R & Data** by Utrecht University RDM Support. *

# Introduction

In this document, we explore a list of over 3,500 pizzas from multiple restaurants in the U.S. The dataset is provided by [Datafiniti's Business Database](https://www.kaggle.com/datafiniti/pizza-restaurants-and-the-pizza-they-sell/home). Datafiniti's Business Database provides business and product information. The data we will explore in this document contains variables like the category, name, address, city, state, menu information and price range for each pizza restaurant. 

## Research questions

Research questions can be:

- *How many pizza restaurants does each state in the U.S. have?*
- *What is the median price of a large plain pizza across the U.S.?*
- ...

The exercises in this document help you aswer the research questions. You can use the structure of this document to make your own reproducible scientific analyses.

## Exercises

This part of the workshop (part II) makes use of exercises to find answers to the research questions. The exercises are divided in two groups:

- **basic exercises** The solution of these exercises are part of the rest of this workshop. The code for these exercises needs to work correctly. Ask questions if you are completely stuck.

- **reading exercises** These are reading execises. The reading exercises make use of the book [R for Data Science](http://r4ds.had.co.nz/) by Garrett Grolemund and Hadley Wickham.

- **optional exercises** These questions might be relevant for you. Please pick a few of these exercises to enhance your skills. It doesn't matter if you do not have time to complete them all. The (+) exercises are beginner exercises. (++) Exercises are of a moderate level. The (+++) exercises are really challenging.

## Technical requirements

This project depends on the `tidyverse` package. Load tidyverse into your work environment. 

```{r} 
library(tidyverse) 
```

# 1. Read and save data

The data about the pizza restaurants is stored in two files. One file contains
the information about the restaurants while the other file contains information
about the pizza's they sell.

### Basic exercise I - Read data files

#### a) Read the dataset `menus.csv`

Complete the code in the code cell below to read the data into
`data_menus`. You can do this with the RStudio interface (with buttons).

*Tip: Use `head(data_menus)` to display the result.*

```{r error=TRUE}
filepath <- file.path('data', 'menus.csv')
data_menus <- ### enter your code here ###


```

#### b) Load `readxl`

The package `readxl` is a tidyverse package to read Excel files. The package
doesn't load when you call `library("tidyverse")`. Load the package with the
function `library()`. 

```{r error=TRUE}

### enter your code here ###

```

#### c) Read the restaurants dataset

Read the restaurants data file `restaurants.xlsx` (Excel file!). Complete the code in the
code cell below and . *Tip: Write `?read_excel` in your console.*

```{r error=TRUE}

filepath <- file.path('data', 'restaurants.xlsx')
data_restaurants <- ### enter your code here ###


```


### Basic exercise II - Dataset properties 

Output the structure of both the restaurants and menus dataset in the cell below. Do this with the function `glimpse()`. What does `<chr>`, `<dbl>` and `<int>` mean? Are these values what you expect?

```{r error=TRUE}

### enter your code here ###

```

### Reading exercise - `readr` versus base R

You might wonder why weâ€™re not using base R functions for (flat) file reading like `read.csv()`, `read.csv2()` and `read.delimiter()`. These function are available by default in base R and don't require additional packages like `readr`. 

Read [Chapter 11.2.1](http://r4ds.had.co.nz/data-import.html#compared-to-base-r)  of [R for Data
Science](http://r4ds.had.co.nz/) and think about the topics like reproducibility, shareablitiy and performance. Discuss your thoughts with another workshop participant.


### Optional exercise (+) - Save data to a CSV file. 

Save the tibble `data_restaurants` to a `.csv` file. Use `;` as delimiter. 

*Tip: check the function `write_delim`.*

```{r error=TRUE}

### enter your code here ###

```

### Optional exercise (++) - Read SPSS, SAS and Excel data files

By default, it is not possible to read SPSS, SAS and Excel files with R. Tidyverse offers some packages to make this possible. These packages aren't loaded and attached by default with  `library(tidyverse)`. The package `haven` and `readxl` can be used to do this. Load the packages with the following lines of code:

```{r}
library("haven") # to read and write SPSS, STATA and SAS files
library("readxl") # to read Excel files
```

#### a) Write data frame to SPSS, SAS, STATA data files. 

Create a code block and try to do the following:

- Write the `data_restaurants` to a SPSS (`.dat`) file
- Read the saved SPSS data file. 
- Write the result of the previous step to a SAS (`.sas7bdat`) file
- Read the SAS file. 
- Write the result of the previous step to a STATA (`.dta`) file
- Read the STATA file. 

Compare the result with `data_restaurants`.


#### b) Write data frame to Excel. 

Write `data_menus` to an Excel file. 

Is there a tidyverse function to do this? If not, read on the internet about
writing Excel files with R.


### Optional exercise (+++) - Parse datetime columns

Date and time variables can be very challenging to work with in programming languages (including R). In the menus dataset, there is a variable `menus.dateSeen`. This column isn't recognized as a date variable. 

```{r error=TRUE}
glimpse(data_menus)
```

The following code shows how you can parse columns with a specific data type. Uncomment the line with `col_date` and insert the correct format for the date column.

```{r error=TRUE}

filepath <- file.path('data', 'menus.csv')

read_csv(filepath,
  col_types = cols(
    menus.amountMax = col_double(),
    menus.amountMin = col_double(),
    menus.currency = col_character(),
    # menus.dateSeen = col_date(format="### insert correct format here ###"),
    menus.description = col_character(),
    menus.name = col_character()
  ))
  
```

# 2. Data visualisation

Visualizing data is important get a feeling for the content of a data set. In the pizza dataset, visualisation is used to explore the values of the columns. Base R has strong plotting functions. To get even better flexibility in plotting, we use the ggplot2 functions `qplot` and `ggplot`. 

### Basic exercise I - Quick plots of the menus

#### a) Single column plots

Make a quick plot of each column in the menus dataset.
```{r error=TRUE}

qplot(data_menus$menus.amountMax)

### enter your code here ###

```
#### b) Two column in plots

Make a quick plot of two columns in the restaurants dataset. Check `priceRangeMin` with `priceRangeMax` and `state` with `priceRangeMax`.

```{r error=TRUE}

qplot(x = data_restaurants$priceRangeMin, y = 

```


### Basic exercise II - Using ggplot for graphs

Complete the following code with different geometric layers. Examples are `geom_point`, `geom_line`, `geom_count` and `geom_density_2d`. 

*Tip: write `geom_` in the search field of the help tab in RStudio.

```{r error=TRUE}

ggplot(data_menus, aes(menus.amountMax, menus.amountMin)) + 
  ### enter your code here ###

```

### Reading exercise - Statistical layers for graphs.

Statistical layers reveal a strong power of ggplot. The following graph illustrates this:

```{r echo=FALSE, message=FALSE, width=4, height=3}
ggplot(mpg, aes(displ, hwy)) +
  geom_point() + geom_smooth()
```

Read [Chapter 3.6](https://r4ds.had.co.nz/data-visualisation.html#geometric-objects)  of [R for Data
Science](http://r4ds.had.co.nz/) and experiment with the function `geom_smooth()` and `stat_smooth()`. What is the difference between both functions? 


### Optional exercise (+) - Scale axes

Scaling of the axes with a ggplot is easy. Take a look at the *data-visualization* cheatsheet. In the bottom right corner of the cheatsheet, you will find the code needed to scale the axes. 

Zoom in on the price range till 100 dollar. 

```{r error=TRUE}
ggplot(data_restaurants, aes(priceRangeMin, priceRangeMax)) + 
  geom_point()
```



### Optional exercise (++) - Plot the restaurants on a map

In this exercise, we plot the restaurants on a map of the USA.

#### a) Install package the `maps`

Install the package `maps` and load the library (both by using code).

```{r}

### enter your code here ###

```

#### b) Plot the restaurants on the map of the USA.

Add a layer with the location of the restaurants.

*tip: can you use the `geom_point()` layer for this?*


```{r error=TRUE}
# usa <- map_data("usa") 

# ggplot(data_restaurants) + 
#   geom_polygon(data = usa, aes(x=long, y = lat))

```


#### c) Use the maximum price to colour the restaurants.

```{r error=TRUE}
# usa <- map_data("usa") 

# ggplot(data_restaurants) + 
#   geom_polygon(data = usa, aes(x=long, y = lat))

```

### Optional exercise (+++) - Create facets. 

Search on the internet for information about facets in ggplot. This unique feature is a must have for data exploration. Create a graph (doesn't matter what kind of graph) and use facets to display them for all states. 

```{r fig.height=15, fig.width=6}

### enter your code here ###

```


# 3. Data transformation

The pizza restaurant data might not be in the format you prefer for analysis. In this section, the transform the data about the pizza restaurants.

### Basic exercise I - Subset data

#### a) Make a selection of all restaurants in 'Los Angeles'.

Make use of the tidyverse (dplyr) function `filter()`.

```{r error=TRUE}

### enter your code here ###

```

#### b) Make a selection of all restaurants in 'Los Angeles' where the variable `priceRangeMin` isn't missing.

How many records satify this condition?

*Tip: Use the function `is.na()` preceded by the `!`. Check the help page for both `is.na` and `!`.*

```{r error=TRUE}

### enter your code here ###

```

#### c) Make a selection of all restaurants in 'Los Angeles' where the variable `priceRangeMin` is not missing. Return only the `address` and `name` of the restaurants. 

Make only use of tidyverse functions.

```{r error=TRUE}

### enter your code here ###

```

### Basic exercise II - Compute the price range

The function `mutate()` is a very powerfull function in tidyverse (dplyr) to mutate column variables in a data frame or tibble. Create a tibble with new variable named `priceRangeDiff` which is the maximum price of a pizza minus the minimum price of a pizza.

```{r error=TRUE}

data_restaurants_with_price_range <- mutate(data_restaurants,  ### enter your code here ### )

head(data_restaurants_with_price_range)
```

Try to use the formatting tips discussed during the presentation.

### Basic exercise III - Filter outliers

Remove the record of `data_restaurants` with outliers on the variables `priceRangeMin` and `priceRangeMax`. Use `ggplot` to create a scatterplot of the 'cleaned' variables. The result should look like the (+) exercise in part 2 (Data visualisation). 

### Reading exercise - Pipe operator

The pipe operator `%>%` is used by many tidyverse users. Read [Chapter 18](https://r4ds.had.co.nz/pipes.html)  of [R for Data
Science](http://r4ds.had.co.nz/). Make a selection columns and rows of the data and make use of the pipe syntax.

### Optional exercise (+) - Exclude variables

Create a tibble of the restaurant dataset without the latitude and longitude. 

Use tidyverse and a maximum of 75 characters. (Our best result is 42 characters.)

```{r}

### enter your code here ###

```

### Optional exercise (++) - Summarise results

The function `summarise()` can be used to summarise the menus dataset. Compute the following variables: 

- the mean minumum price
- the mean maximum price of the pizzas
- the median difference between the minimum and maximum price

*Tip: Use the cheatsheet or R4DS

```{r}

```

### Optional exercise (+++) - Join datasets

Quickly read [13.4.1](https://r4ds.had.co.nz/relational-data.html#understanding-joins)-[13.4.3](https://r4ds.had.co.nz/relational-data.html#outer-join) from R for Data Science. Focus on the images.

In this exercise, append restaurant data to each pizza. What kind of join is this? *Hint: Check the data transformation cheatsheet, section 'Combine Tables'.*

The join key for our pizza datasets is `id`. 

```{r error=TRUE}

# data_pizza_with_restaurant <- ..._join()

```

Multiple options give the same results. Explain why!
